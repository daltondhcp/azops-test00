{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "input": {
      "value": {
        "Name": "d8d26049-3e13-4b29-af46-26c798d4d661",
        "ResourceType": "Microsoft.Authorization/policyDefinitions",
        "Properties": {
          "Description": null,
          "DisplayName": "mYdEPLOY-MDE",
          "Metadata": {},
          "Mode": "All",
          "Parameters": {
            "listOfImageIdToInclude": {
              "type": "Array",
              "metadata": {
                "displayName": "Optional: List of virtual machine images that have supported Windows OS to add to scope",
                "description": "Example value: '/subscriptions/<subscriptionId>/resourceGroups/YourResourceGroup/providers/Microsoft.Compute/images/ContosoStdImage'"
              },
              "defaultValue": []
            },
            "effect": {
              "type": "String",
              "metadata": {
                "displayName": "Effect",
                "description": "Enable or disable the execution of the policy"
              },
              "allowedValues": [
                "DeployIfNotExists",
                "Disabled"
              ],
              "defaultValue": "DeployIfNotExists"
            }
          },
          "PolicyRule": {
            "if": {
              "allOf": [
                {
                  "field": "type",
                  "equals": "Microsoft.Compute/virtualMachineScaleSets"
                },
                {
                  "anyOf": [
                    {
                      "field": "Microsoft.Compute/imageId",
                      "in": "[parameters('listOfImageIdToInclude')]"
                    },
                    {
                      "allOf": [
                        {
                          "field": "Microsoft.Compute/imagePublisher",
                          "equals": "MicrosoftWindowsServer"
                        },
                        {
                          "field": "Microsoft.Compute/imageOffer",
                          "equals": "WindowsServer"
                        },
                        {
                          "field": "Microsoft.Compute/imageSKU",
                          "in": [
                            "2008-R2-SP1",
                            "2008-R2-SP1-smalldisk",
                            "2012-Datacenter",
                            "2012-Datacenter-smalldisk",
                            "2012-R2-Datacenter",
                            "2012-R2-Datacenter-smalldisk",
                            "2016-Datacenter",
                            "2016-Datacenter-Server-Core",
                            "2016-Datacenter-Server-Core-smalldisk",
                            "2016-Datacenter-smalldisk",
                            "2016-Datacenter-with-Containers",
                            "2016-Datacenter-with-RDSH",
                            "2019-Datacenter",
                            "2019-Datacenter-Core",
                            "2019-Datacenter-Core-smalldisk",
                            "2019-Datacenter-Core-with-Containers",
                            "2019-Datacenter-Core-with-Containers-smalldisk",
                            "2019-Datacenter-smalldisk",
                            "2019-Datacenter-with-Containers",
                            "2019-Datacenter-with-Containers-smalldisk",
                            "2019-Datacenter-zhcn",
                            "2019-datacenter-gensecond"
                          ]
                        }
                      ]
                    },
                    {
                      "allOf": [
                        {
                          "field": "Microsoft.Compute/imagePublisher",
                          "equals": "MicrosoftWindowsServer"
                        },
                        {
                          "field": "Microsoft.Compute/imageOffer",
                          "equals": "WindowsServerSemiAnnual"
                        },
                        {
                          "field": "Microsoft.Compute/imageSKU",
                          "in": [
                            "Datacenter-Core-1709-smalldisk",
                            "Datacenter-Core-1709-with-Containers-smalldisk",
                            "Datacenter-Core-1803-with-Containers-smalldisk"
                          ]
                        }
                      ]
                    },
                    {
                      "allOf": [
                        {
                          "field": "Microsoft.Compute/imagePublisher",
                          "equals": "MicrosoftWindowsServerHPCPack"
                        },
                        {
                          "field": "Microsoft.Compute/imageOffer",
                          "equals": "WindowsServerHPCPack"
                        }
                      ]
                    },
                    {
                      "allOf": [
                        {
                          "field": "Microsoft.Compute/imagePublisher",
                          "equals": "MicrosoftSQLServer"
                        },
                        {
                          "anyOf": [
                            {
                              "field": "Microsoft.Compute/imageOffer",
                              "like": "*-WS2016"
                            },
                            {
                              "field": "Microsoft.Compute/imageOffer",
                              "like": "*-WS2016-BYOL"
                            },
                            {
                              "field": "Microsoft.Compute/imageOffer",
                              "like": "*-WS2012R2"
                            },
                            {
                              "field": "Microsoft.Compute/imageOffer",
                              "like": "*-WS2012R2-BYOL"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "allOf": [
                        {
                          "field": "Microsoft.Compute/imagePublisher",
                          "equals": "MicrosoftRServer"
                        },
                        {
                          "field": "Microsoft.Compute/imageOffer",
                          "equals": "MLServer-WS2016"
                        }
                      ]
                    },
                    {
                      "allOf": [
                        {
                          "field": "Microsoft.Compute/imagePublisher",
                          "equals": "MicrosoftVisualStudio"
                        },
                        {
                          "field": "Microsoft.Compute/imageOffer",
                          "in": [
                            "VisualStudio",
                            "Windows"
                          ]
                        }
                      ]
                    },
                    {
                      "allOf": [
                        {
                          "field": "Microsoft.Compute/imagePublisher",
                          "equals": "MicrosoftDynamicsAX"
                        },
                        {
                          "field": "Microsoft.Compute/imageOffer",
                          "equals": "Dynamics"
                        },
                        {
                          "field": "Microsoft.Compute/imageSKU",
                          "equals": "Pre-Req-AX7-Onebox-U8"
                        }
                      ]
                    },
                    {
                      "allOf": [
                        {
                          "field": "Microsoft.Compute/imagePublisher",
                          "equals": "MicrosoftDynamicsAX"
                        },
                        {
                          "field": "Microsoft.Compute/imageOffer",
                          "equals": "Dynamics"
                        },
                        {
                          "field": "Microsoft.Compute/imageSKU",
                          "equals": "Pre-Req-AX7-Onebox-V4"
                        }
                      ]
                    },
                    {
                      "allOf": [
                        {
                          "field": "Microsoft.Compute/imagePublisher",
                          "equals": "microsoft-ads"
                        },
                        {
                          "field": "Microsoft.Compute/imageOffer",
                          "equals": "windows-data-science-vm"
                        }
                      ]
                    },
                    {
                      "allOf": [
                        {
                          "field": "Microsoft.Compute/imagePublisher",
                          "equals": "MicrosoftWindowsDesktop"
                        },
                        {
                          "field": "Microsoft.Compute/imageOffer",
                          "equals": "Windows-10"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            "then": {
              "effect": "[parameters('effect')]",
              "details": {
                "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
                "existenceCondition": {
                  "allOf": [
                    {
                      "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/type",
                      "equals": "Microsoft.Compute.CustomScriptExtension"
                    },
                    {
                      "field": "Microsoft.Compute/virtualMachineScaleSets/extensions/publisher",
                      "equals": "CustomScriptExtension"
                    }
                  ]
                },
                "roleDefinitionIds": [
                  "/providers/microsoft.authorization/roleDefinitions/9980e02c-c2be-4d73-94e8-173b1dc7cf3c"
                ],
                "deployment": {
                  "properties": {
                    "mode": "Incremental",
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "parameters": {
                        "vmName": {
                          "type": "string"
                        },
                        "location": {
                          "type": "string"
                        },
                        "vmssResourceId": {
                          "type": "string"
                        }
                      },
                      "variables": {
                        "vmExtensionName": "MDE.Windows",
                        "vmExtensionPublisher": "Microsoft.Azure.AzureDefenderForServers",
                        "vmExtensionType": "MDE.Windows",
                        "vmExtensionTypeHandlerVersion": "1.0"
                      },
                      "resources": [
                        {
                          "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
                          "apiVersion": "2021-11-01",
                          "name": "[concat(parameters('vmName'), '/', variables('vmExtensionName'))]",
                          "location": "[parameters('location')]",
                          "properties": {
                            "autoUpgradeMinorVersion": true,
                            "publisher": "[variables('vmExtensionPublisher')]",
                            "type": "[variables('vmExtensionType')]",
                            "typeHandlerVersion": "[variables('vmExtensionTypeHandlerVersion')]",
                            "settings": {
                              "azureResourceId": "[parameters('vmssResourceId')]"
                            },
                            "protectedSettings": {
                              "defenderForEndpointOnboardingScript": "[reference(subscriptionResourceId('Microsoft.Security/mdeOnboardings', 'Windows'), '2021-10-01-preview', 'full').properties.onboardingPackageWindows]"
                            }
                          }
                        }
                      ],
                      "outputs": {
                        "policy": {
                          "type": "string",
                          "value": "[concat('Enabled extension for: ', parameters('vmName'))]"
                        }
                      }
                    },
                    "parameters": {
                      "vmName": {
                        "type": "[field('name')]"
                      },
                      "location": {
                        "value": "[field('location')]"
                      },
                      "vmssResourceId": {
                        "value": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Compute/virtualMachineScaleSets/',field('name'))]"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }
}
